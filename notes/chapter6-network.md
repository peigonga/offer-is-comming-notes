## 网络与负载均衡

#### OSI七层网络模型
从下到上主要分为：
- 物理层：定义物理设备的标准，主要作用是传输比特流，具体做法是在发送端将1、0码
  转化为电流强弱来进行传输，在到达目的地后再将电流强弱转化为1、0码，也就是
  常说的模数转化、数模转化，这一层的数据叫做比特
- 数据链路层：主要用于对数据包中的MAC地址进行解析和封装。这一层的数据叫做帧。
  在这一层工作的设备是网卡、网桥、交换机
- 网络层：主要用于对数据包中的IP地址进行封装和解析，这一层的数据叫做数据包。
  在这一层工作的设备有路由器、交换机、防火墙等。
- 传输层：传输层定义了数据的协议和端口号，主要用于数据的分段、传输和重组。在
  这一层工作的协议由TCP、UDP等。TCP是传输控制协议，传输效率低，可靠性强，
  用于传输对可靠性要求高、数据量小的数据，比如支付宝转账时用的就是TCP；
  UDP是用户数据报协议，与TCP的特性恰恰相反，用于传输可靠性要求不高、数据量大
  的数据，例如抖音等视频服务就使用了UDP。
- 会话层：在传输层的基础上建立连接和管理会话，具体包括登录验证、断点续传、
  数据粘包与分包等、在设备之间需要相互识别的可以是IP，也可以是MAC或者主机名
- 表示层：主要对接受的数据进行解释、加密、解密、压缩、解压等，即把计算机能够
  识别的内容转换成人能够识别的内容(图片、声音、文字等)
- 应用层：基于网络构建具体应用，例如FTP文件上传下载服务、Telnet服务、
  HTTP服务、DNS服务、SNMP邮件服务等。
  
#### TCP/IP四层网络模型
TCP/IP不是指TCP和IP这两个协议的合称，而是指因特网的整个TCP/IP协议簇。
从协议分层方面来讲，TCP/IP有四个层次组成：
- 网络接口层：定义了主机间网络连通的协议，具体包括Echernet、FDDI、ATM
  等通信协议。
- 网络层：主要用于数据的传输、路由及地址的解析，以保障主机可以把数据发送
  给任何网络上的目标，数据经过网络传输，发送的顺序和到达的顺序可能发生变化。
  在网络层使用IP(Internet Protocol)和地址解析协议(ARP)
- 传输层：使源端和目的端机器上的对等实体可以基于会话相互通信。在这一层
  定义了两个端到端的协议TCP和UDP。TCP是面向连接的协议，提供可靠的报文
  传输和对上层应用的连接服务，除了基本的数据传输，它还有可靠性保证、
  流量控制、多路复用、优先权和安全性控制等功能。UDP是面向无连接的不可靠
  传输的协议，主要用于不需要类似TCP的可靠性保障和流量控制等功能的应用程序
- 应用层：负责具体应用层协议的定义，包括Telnet(TELecommunications NETwork虚拟终端协议)、
  FTP(File Transfer Protocol文件传输协议)、SMTP(Simple Mail Transfer Protocol电子邮件传输协议)、
  DNS(Domain Name Service域名服务)、NNTP(Net News Transfer Protocol网上新闻传输协议)
  和HTTP(HyperText Transfer Protocol超文本传输协议)
  
#### TCP三次握手/四次挥手

#### HTTP的原理
HTTP是一个无状态的协议，无状态指在客户端(Web浏览器)和服务器之间不需要建立
持久的连接，在一个客户端向服务器端发出请求且服务器收到该请求并返回响应后，
本次通信结束，HTTP连接将被关闭，服务器不保留连接的相关信息。
HTTP尊亲请求(Request)/应答(Response)模型，客户端向服务器发送请求，服务器
处理请求并返回适当的应答。
- HTTP的传输流程：包括地址解析、封装HTTP数据包、封装TCP包、建立TCP连接
  客户端发送请求、服务端响应、服务端关闭TCP连接
  1. 地址解析：通过DNS解析服务器域名从而获得主机的IP地址。
  2. 封装HTTP数据包：解析协议名、主机名、端口、对象路径等并结合本机自己
     的信息封装成一个HTTP请求数据包
  3. 封装TCP包：将HTTP请求数据包进一步封装成TCP数据包
  4. 建立TCP连接：基于TCP三次握手机制建立TCP连接
  5. 客户端发送请求：在建立连接后，客户端发送一个请求给服务器
  6. 服务器响应：服务器在接收到请求后，结合业务逻辑进行数据处理，然后向
     客户端返回相应的响应信息。响应信息包含状态行、协议版本号、成功或
     错误的代码、消息体等内容
  7. 服务器关闭TCP连接：服务器在向浏览器发送请求相应数据后关闭TCP连接。
     但如果浏览器或者服务器在消息头加入了Connection : Keep-Alive，
     则TCP连接在请求相应数据发送后仍然保持连接状态，在下一次请求中
     浏览器可以继续使用相同的连接发送请求。采用Keep-Alive方式不但
     减少了请求响应的时间，还节约了网络带宽和系统资源。
 
- HTTPS:是以安全为目标的HTTP通道，他在HTTP中加入SSL层以提高数据传输的安全性。
  加密流程如下：
  1. 发起请求：客户端在通过TCP和服务器建立连接之后，发出一个请求证书的消息给
     服务器，在该请求消息里包含自己可以实现的算法列表和其他需要的消息。
  2. 证书返回：服务器在收到消息后回应客户端并返回证书，在整数中包含服务器信息。
     域名、申请证书的公司、公钥、数据加密算法等。
  3. 证书验证：客户端在收到证书后，判断证书签发机构是否正确，并使用该签发
     机构的公钥确认签名是否有效，客户端还会确保在证书中列出的域名为正在
     连接的域名。如果客户端确认证书有效，则生成对称密钥，并使用公钥将对称
     秘钥加密
  4. 秘钥交换：客户端将加密后的对称秘钥发送给服务器，服务器在接收到对称秘钥后
     使用私钥解密。
  5. 数据传输：经过上述步骤，客户端和服务器就完成了秘钥对的交换，在之后的数据
     传输过程中，客户端和服务器就可以基于对称加密将数据加密后在网络上传输
     
#### CDN的原理
(Content Delivery Network,内容分发网络)指基于部署在各地的机房服务器，
通过中心平台的负载均衡、内容分发、调度的能力，使用户就近获取所需内容，降低
网络延迟，提升用户访问的响应速度
1. CDN的关键技术：
    - 内容发布：借助建立索引、缓存、流分裂、组播等技术，将内容发布到网络上
    距离用户最近的中心机房
    - 内容路由：通过内容路由器中的重定向机制，在多个中心机房的服务器上负载
     均衡用户的请求，使用户从最近的中心机房获取数据
    - 内容交换：根据内容的可用性、服务器的可用性及用户北京，在缓存服务器上
     利用应用层交换、流分裂、重定向等技术，智能的平衡负载流量
    - 性能管理：通过内部和外部监控系统，获取网络部件的信息，测量内容发布的
     端到端性能(包丢失、延迟、平均带宽、启动时间、帧速率等)，保证网络处于
     最佳运行状态

2. CDN的特点：
    - 本地缓存
    - 镜像服务
    - 远程加速
    - 带宽优化
    - 抗集群攻击
  
3. 内容分发系统：<br>
  将用户请求的数据分发到就近的各个中心机房，以保障为用户提供
  快速、搞笑的内容服务
  
4. 负载均衡系统：<br>
  负载均衡系统是整个CDN系统的核心，负载均衡根据当前网络的流量分布、各
  中心机房服务器的负载和用户请求的特点将用户的请求负载到不同的中心机房
  或不同的服务器上，以保障用户内容访问的流畅性。负载均衡系统包括全局负载
  均衡(GSLB)和本地负载均衡(SLB)
    - 全局负载均衡主要指跨机房的负载均衡，通过DNS解析或者应用层重定向技术
    将用户的请求负载到就近的中心机房
    - 本地负载均衡主要指机房内部的负载均衡，一般通过缓存服务器，基于LVS、
    Nginx、服务网关等技术实现用户访问的负载
    
5. 管理系统
 
#### 负载均衡
负载均衡建立在现有网络结构之上，提供了一种廉价、有效、透明的方法老扩展网络
设备和服务器的带宽，增加了吞吐量，加强了网络数据处理能力，并提高了网络的
灵活性和可用性。常用的负载均衡有：
- 四层负载均衡：基于IP和端口的方式实现网络的负载均衡，具体实现为对外提供给一个
  虚拟的IP地址和端口接收所有用户的请求，然后根据负载均衡配置和负载均衡策略
  将请求发送给真实的服务器。常用的软硬件如下：
    - F5：硬件负载均衡器，功能完备，价格昂贵
    - LVS：基于IP+端口实现的四层负载软件，常和Keepalive配合使用
    - Nginx：同时实现四层负载和七层负载，带缓存功能，可基于正则表达式
      灵活转发
- 七层负载均衡：局域URL等资源来实现应用层基于内容的负载均衡，具体实现为通过
  虚拟的URL或主机名接收所有用户的请求，然后将请求发送给真实的服务器。
  常用软件如下：
    - HAProxy：支持其曾代理、会话保持、标记、路径转移等
    - Nginx：在HTTP和Mail协议上功能比较好，性能与HAProxy相当
    - Apache：使用简单，性能较差

