## 数据库及分布式事务

#### 数据库三范式
1. 第一范式：如果每列都是不可再分的最小数据单元，则满足第一范式，
   第一范式的目标是确保每列的原子性
2. 第二范式：在第一范式的基础上，规定表中的非主键列不存在对主键的部分依赖，
   即第二范式要求每个表只描述一件事情。
3. 第三范式：满足第一第二范式，并且表中的列不存在对非主键列的传递依赖。


### 分布式事务
#### CAP原理
又称CAP定理，指的是在一个分布式系统中，一致性(Consistency)、可用性(Availability)
和分区容错性(Partition tolerance)三者不可兼得。
- 一致性：在分布是系统的所有数据备份中，在同一时刻是否有同样的值(等同于
  所有节点都访问同一份最新的数据副本)
- 可用性：在集群中一部分节点发生故障后，集群整体能否响应客户端的读写请求
  (对数据更新具备高可用性)
- 分区容错性：系统如果不能再时限内达成数据一致性，就意味着发生了分区，必须
  就当前操作在C和A之间错处选择。以实际效果而言，分区相当于对通信的时限要求。

#### 两段提交协议
(Two-Phase Commit)指在计算机网络及数据库领域内，为了使分布式数据库的所有
节点在进行事务提交都保持一致性而设计的一种算法。
算法思路可以概括为：参与者将操作成败通知协调者，再由协调者根据所有参与者的反馈
决定各参与者是提交操作还是终止操作。
1. 准备阶段：协调者给每个参与者发送Prepare消息，每个参与者执行本第事务，
   写本地redo和undo但是不提交
2. 协调者收到了参与者的失败消息或等待超时，则直接给每个参与者都发送回滚，
   否则发送提交消息。
3. 缺点：
    - 同步阻塞问题：在执行过程中，所有参与者的任务都是阻塞执行的
    - 单点故障：所有请求都需要经过协调者，在协调者发生故障时，所有参与者都会被阻塞
    - 数据不一致：在第二阶段，协调者向参与者发送Commit后发生了网络异常，
      或发送Commit过程中协调者发生了故障，导致只有一部分参与者接收到了
      Commit
    - 协调者宕机后事务状态丢失：协调者在发送Commit后宕机，唯一接收到这条消息的
      参与者也宕机，即使协调者通过选举协议产生了新的协调者，这条事务的状态
      也是不可确定的

#### 三段提交协议
(Three-Phase Commit)是二阶段提交的改进版。
- 引入超市机制：在协调者与参与者中引入超时机制，如果协调者长时间接收不到参与者
  的反馈，则认为参与者执行失败。
- 在第一第二阶段都加入一个预准备阶段，以保证在最后的任务提交之前各参与节点的
  状态是一致的。也就是说，除了引入超时机制，三阶段提交协议把两阶段提交协议
  的准备阶段再次一分为二，这样三阶段提交就有CanCommit、PreCommit、DoCommit
  三个阶段

1. CanCommit：协调者向参与者发送Commit请求，参与者如果可以提交就返回Yes
   响应，否则返回No响应
2. PreCommit：
    - 假如协调者从所有参与者那里获得的反馈都是Yes，就预执行事务
    - 假如有任意参与者向协调者发送了No，或者超时之后则执行事务的中断
3. DoCommit：该阶段进行真正的事务提交，主要包括：协调者发送提交请求、
   参与者提交事务、参与者响应反馈、协调者确定完成事务
   
#### 柔性食物
BASE理论是CAP理论的眼神，包括基本可用(Basically Available)、柔性状态
(Soft State)、最终一致性(Eventual Consistency)三个原则，并基于这三个
原则设计出了柔性事务。
<br>
我们通常所说的柔性事务分为：两阶段型、补偿型、异步确保型、最大努力通知型
